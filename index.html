<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wii-Style Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">
    <header class="toolbar">
      <div class="toolbar-left">
        <div class="logo-orb"></div>
        <span class="logo-text">MiiBoard</span>
      </div>
      <div class="toolbar-center">
        <a href="index.html" class="toolbar-btn toolbar-btn-active">Home</a>
        <a href="stats.html" class="toolbar-btn">Stats</a>
        <a href="transfer.html" class="toolbar-btn">Transfer</a>
      </div>
      <div class="toolbar-right">
        <div class="corn-wallet-wrapper">
          <div class="corn-balance" id="corn-balance" aria-expanded="false">
            ðŸŒ½ <span class="corn-balance-value">0</span>
          </div>
          <div class="corn-wallet" id="corn-wallet" aria-hidden="true">
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Current corn</span>
              <span class="corn-wallet-value corn-wallet-current">0</span>
            </div>
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Total harvested</span>
              <span class="corn-wallet-value corn-wallet-total">0</span>
            </div>
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Best harvest</span>
              <span class="corn-wallet-value corn-wallet-best">0</span>
            </div>
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Last harvest</span>
              <span class="corn-wallet-value corn-wallet-last">â€”</span>
            </div>
          </div>
        </div>
        <span class="toolbar-time" id="toolbar-time">--:--</span>
        <div class="avatar"></div>
      </div>
    </header>
    <main class="dashboard">
      <section class="main-panel">
        <div class="main-panel-inner">
          <div class="farm-header">
            <h1 class="main-panel-title">Corn Fields</h1>
            <p class="main-panel-subtitle">Click a field to plant, wait for it to grow, then harvest to gain corn.</p>
          </div>
          <div class="fields-grid">
            <button class="field" data-field-id="0">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 1</div>
            </button>
            <button class="field" data-field-id="1">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 2</div>
            </button>
            <button class="field" data-field-id="2">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 3</div>
            </button>
            <button class="field" data-field-id="3">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 4</div>
            </button>
            <button class="field" data-field-id="4">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 5</div>
            </button>
            <button class="field" data-field-id="5">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 6</div>
            </button>
            <button class="field" data-field-id="6">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 7</div>
            </button>
            <button class="field" data-field-id="7">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Field 8</div>
            </button>
            <button class="field field-special field-special-left" data-field-id="8">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Amethyst Field 1</div>
            </button>
            <button class="field field-special field-special-right" data-field-id="9">
              <div class="field-land">
                <div class="field-crops">
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                  <span class="field-corn">ðŸŒ½</span>
                </div>
              </div>
              <div class="field-progress">
                <div class="field-progress-bar" style="width: 0%;"></div>
              </div>
              <div class="field-status">Empty</div>
              <div class="field-label">Amethyst Field 2</div>
            </button>
          </div>
        </div>
      </section>
    </main>
    <div class="global-toast" id="ready-toast" aria-live="polite" aria-atomic="true"></div>
  </div>
  <script>
    var cornBalance = 0;
    var fieldStates = [];
    var CORN_PER_HARVEST = 12;
    var BOUNTIFUL_MULTIPLIER = 2;
    var BOUNTIFUL_CHANCE = 0.25;
    var CORN_STORAGE_KEY = 'miiboard_corn_balance';
    var CORN_LAST_SEEN_KEY = 'miiboard_last_seen';
    var FIELD_STORAGE_KEY = 'miiboard_field_states';
    var FIELD_GROWTH_MS = 10000;
    var fieldTickIntervalId = null;
    var readyToastHideTimerId = null;
    var lastReadyToastCount = 0;
    var totalHarvested = 0;
    var bestHarvest = 0;
    var lastHarvest = 0;

    function updateTime() {
      var el = document.getElementById('toolbar-time');
      if (!el) return;
      var now = new Date();
      var hours = now.getHours();
      var minutes = now.getMinutes().toString().padStart(2, '0');
      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      el.textContent = hours + ':' + minutes + ' ' + ampm;
    }

    function updateCornBalanceDisplay() {
      var container = document.getElementById('corn-balance');
      if (!container) return;
      var valueEl = container.querySelector('.corn-balance-value');
      if (valueEl) {
        valueEl.textContent = cornBalance;
      } else {
        container.textContent = 'ðŸŒ½ ' + cornBalance;
      }
    }

    function loadCornBalance() {
      try {
        if (!window.localStorage) return;
        var stored = localStorage.getItem(CORN_STORAGE_KEY);
        if (stored !== null) {
          var parsed = parseInt(stored, 10);
          if (!isNaN(parsed) && parsed >= 0) {
            cornBalance = parsed;
          }
        }
      } catch (e) {
        // ignore storage errors
      }
    }

    function saveCornBalance() {
      try {
        if (!window.localStorage) return;
        localStorage.setItem(CORN_STORAGE_KEY, String(cornBalance));
        localStorage.setItem(CORN_LAST_SEEN_KEY, String(Date.now()));
      } catch (e) {
        // ignore storage errors
      }
    }

    function updateCornWalletDisplay() {
      var wallet = document.getElementById('corn-wallet');
      if (!wallet) return;
      var currentEl = wallet.querySelector('.corn-wallet-current');
      var totalEl = wallet.querySelector('.corn-wallet-total');
      var bestEl = wallet.querySelector('.corn-wallet-best');
      var lastEl = wallet.querySelector('.corn-wallet-last');
      if (currentEl) currentEl.textContent = cornBalance;
      if (totalEl) totalEl.textContent = totalHarvested;
      if (bestEl) bestEl.textContent = bestHarvest;
      if (lastEl) lastEl.textContent = lastHarvest > 0 ? lastHarvest : 'â€”';
    }

    function applyOfflineBonus() {
      try {
        if (!window.localStorage) return;
        var stored = localStorage.getItem(CORN_LAST_SEEN_KEY);
        if (!stored) {
          localStorage.setItem(CORN_LAST_SEEN_KEY, String(Date.now()));
          return;
        }
        var previous = parseInt(stored, 10);
        if (isNaN(previous)) {
          localStorage.setItem(CORN_LAST_SEEN_KEY, String(Date.now()));
          return;
        }
        var now = Date.now();
        var diffMinutes = Math.floor((now - previous) / 60000);
        var bonus = Math.min(Math.floor(diffMinutes / 5), 20);
        if (bonus > 0) {
          cornBalance += bonus;
          totalHarvested += bonus;
          lastHarvest = bonus;
          updateCornBalanceDisplay();
          updateCornWalletDisplay();
          saveCornBalance();
          return;
        }
        localStorage.setItem(CORN_LAST_SEEN_KEY, String(now));
      } catch (e) {
        // ignore storage errors
      }
    }

    function bindCornWallet() {
      var balance = document.getElementById('corn-balance');
      var wallet = document.getElementById('corn-wallet');
      if (!balance || !wallet) return;
      var isOpen = false;

      function setOpen(open) {
        isOpen = open;
        if (open) {
          wallet.classList.add('is-open');
          balance.setAttribute('aria-expanded', 'true');
          wallet.setAttribute('aria-hidden', 'false');
        } else {
          wallet.classList.remove('is-open');
          balance.setAttribute('aria-expanded', 'false');
          wallet.setAttribute('aria-hidden', 'true');
        }
      }

      balance.setAttribute('role', 'button');
      balance.setAttribute('tabindex', '0');

      balance.addEventListener('click', function (event) {
        event.stopPropagation();
        setOpen(!isOpen);
      });

      balance.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          setOpen(!isOpen);
        }
      });

      document.addEventListener('click', function (event) {
        if (!isOpen) return;
        if (!wallet.contains(event.target) && !balance.contains(event.target)) {
          setOpen(false);
        }
      });
    }

    function createFieldState(element, index) {
      var isSpecial = element.classList.contains('field-special');
      return {
        el: element,
        index: typeof index === 'number' ? index : 0,
        progress: 0,
        state: 'empty',
        startTime: null,
        growMs: isSpecial ? FIELD_GROWTH_MS * 4 : FIELD_GROWTH_MS,
        perHarvest: isSpecial ? CORN_PER_HARVEST * 3 : CORN_PER_HARVEST,
        bountifulChance: isSpecial ? BOUNTIFUL_CHANCE * 2 : BOUNTIFUL_CHANCE
      };
    }

    function saveFieldStates() {
      try {
        if (!window.localStorage) return;
        var compact = fieldStates.map(function (field) {
          return {
            state: field.state,
            progress: field.progress,
            startTime: field.startTime
          };
        });
        localStorage.setItem(FIELD_STORAGE_KEY, JSON.stringify(compact));
      } catch (e) {
        // ignore storage errors
      }
    }

    function loadStoredFieldStates() {
      try {
        if (!window.localStorage) return null;
        var raw = localStorage.getItem(FIELD_STORAGE_KEY);
        if (!raw) return null;
        var parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch (e) {
        return null;
      }
    }

    function applyStoredFieldStates() {
      var stored = loadStoredFieldStates();
      if (!stored || !fieldStates || !fieldStates.length) return;
      var now = Date.now();
      fieldStates.forEach(function (field, index) {
        var data = stored[index];
        if (!data) return;
        field.state = data.state || 'empty';
        field.startTime = typeof data.startTime === 'number' ? data.startTime : null;

        var progress = typeof data.progress === 'number' ? data.progress : 0;

        if (field.state === 'growing') {
          var growMs = field.growMs || FIELD_GROWTH_MS;
          // Backfill missing startTime for older saves using stored progress
          if (typeof field.startTime !== 'number') {
            if (progress > 0 && progress < 100) {
              field.startTime = now - (progress / 100) * growMs;
            } else {
              field.startTime = now;
            }
          }

          var elapsed = now - field.startTime;
          var pct = (elapsed / growMs) * 100;
          if (pct >= 100) {
            pct = 100;
            field.state = 'ready';
            field.startTime = null;
          }
          progress = pct;
        }

        field.progress = Math.max(0, Math.min(100, progress));
        updateFieldUI(field);
      });
      updateReadyToastFromFields();
    }

    function formatFieldCountdown(field) {
      var growMs = field.growMs || FIELD_GROWTH_MS;
      var remainingMs;
      if (field.startTime) {
        remainingMs = growMs - (Date.now() - field.startTime);
      } else {
        var pct = typeof field.progress === 'number' ? field.progress : 0;
        remainingMs = growMs - (pct / 100) * growMs;
      }
      if (!isFinite(remainingMs)) remainingMs = 0;
      if (remainingMs < 0) remainingMs = 0;
      var seconds = Math.floor(remainingMs / 1000);
      var hundredths = Math.floor((remainingMs % 1000) / 10);
      return seconds + '.' + String(hundredths).padStart(2, '0') + 's';
    }

    function updateFieldUI(field) {
      var bar = field.el.querySelector('.field-progress-bar');
      var status = field.el.querySelector('.field-status');
      if (bar) {
        bar.style.width = field.progress + '%';
      }
      if (status) {
        if (field.state === 'empty') {
          status.textContent = 'Empty';
        } else if (field.state === 'growing') {
          status.textContent = formatFieldCountdown(field);
        } else if (field.state === 'ready') {
          status.textContent = 'Tap to harvest!';
        }
      }
      field.el.classList.remove('field-empty', 'field-growing', 'field-ready');
      field.el.classList.add('field-' + field.state);

      var corns = field.el.querySelectorAll('.field-corn');
      corns.forEach(function (corn) {
        if (field.state === 'growing') {
          corn.textContent = 'ðŸŒ±';
        } else {
          corn.textContent = 'ðŸŒ½';
        }
      });
    }

    function getReadyFieldCount() {
      var count = 0;
      fieldStates.forEach(function (field) {
        if (field.state === 'ready') {
          count++;
        }
      });
      return count;
    }

    function showReadyToast(count) {
      var toast = document.getElementById('ready-toast');
      if (!toast) return;
      var label = count === 1 ? '1 field is ready to harvest' : count + ' fields are ready to harvest';
      toast.textContent = 'ðŸŒ½ ' + label;
      toast.classList.add('is-visible');
      if (readyToastHideTimerId !== null) {
        clearTimeout(readyToastHideTimerId);
      }
      readyToastHideTimerId = setTimeout(function () {
        toast.classList.remove('is-visible');
      }, 3500);
    }

    function updateReadyToastFromFields() {
      var count = getReadyFieldCount();
      if (count > 0 && count !== lastReadyToastCount) {
        lastReadyToastCount = count;
        showReadyToast(count);
      }
    }

    function updateGrowingFieldsFromTime() {
      var now = Date.now();
      var changed = false;
      fieldStates.forEach(function (field) {
        if (field.state === 'growing' && field.startTime) {
          var growMs = field.growMs || FIELD_GROWTH_MS;
          var pct = (now - field.startTime) / growMs * 100;
          if (pct >= 100) {
            pct = 100;
            field.state = 'ready';
            field.startTime = null;
          }
          var clamped = Math.max(0, Math.min(100, pct));
          if (clamped !== field.progress) {
            field.progress = clamped;
            changed = true;
          }
          updateFieldUI(field);
        }
      });
      if (changed) {
        saveFieldStates();
      }
      updateReadyToastFromFields();
    }

    function startFieldTickLoop() {
      if (fieldTickIntervalId !== null) {
        clearInterval(fieldTickIntervalId);
      }
      fieldTickIntervalId = setInterval(updateGrowingFieldsFromTime, 500);
    }

    function startGrowing(field) {
      if (field.state !== 'empty') return;
      field.state = 'growing';
      field.progress = 0;
      field.startTime = Date.now();
      updateFieldUI(field);
      saveFieldStates();
    }

    function harvest(field) {
      if (field.state !== 'ready') return;
      var baseAmount = field.perHarvest || CORN_PER_HARVEST;
      var chance = field.bountifulChance || BOUNTIFUL_CHANCE;
      var amount = baseAmount;
      var isBountiful = Math.random() < chance;
      if (isBountiful) {
        amount = amount * BOUNTIFUL_MULTIPLIER;
      }
      cornBalance += amount;
      updateCornBalanceDisplay();
      saveCornBalance();
      totalHarvested += amount;
      lastHarvest = amount;
      if (amount > bestHarvest) {
        bestHarvest = amount;
      }
      updateCornWalletDisplay();
      var status = field.el.querySelector('.field-status');
      var chip = null;
      try {
        chip = document.createElement('div');
        chip.className = 'field-reward-chip';
        chip.textContent = '+' + amount;
        field.el.appendChild(chip);
      } catch (e) {
        chip = null;
      }
      field.state = 'empty';
      field.progress = 0;
      field.startTime = null;
      updateFieldUI(field);
      saveFieldStates();
      if (status) {
        status.textContent = isBountiful ? 'Bountiful harvest! +' + amount : 'Harvested +' + amount;
      }
      if (isBountiful) {
        field.el.classList.add('field-bountiful');
      }
      setTimeout(function () {
        field.el.classList.remove('field-bountiful');
        if (chip && chip.parentNode) {
          chip.parentNode.removeChild(chip);
        }
        updateFieldUI(field);
      }, 900);
    }

    function bindFieldEvents() {
      var nodes = document.querySelectorAll('.field');
      fieldStates = [];
      nodes.forEach(function (node, index) {
        var field = createFieldState(node, index);
        fieldStates.push(field);
        node.setAttribute('type', 'button');
        node.setAttribute('tabindex', '0');
        node.addEventListener('click', function () {
          if (field.state === 'empty') {
            startGrowing(field);
          } else if (field.state === 'ready') {
            harvest(field);
          }
        });
        node.addEventListener('keydown', function (event) {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            node.click();
          }
        });
        updateFieldUI(field);
      });
      applyStoredFieldStates();
    }

    function initDashboard() {
      updateTime();
      setInterval(updateTime, 60000);
      loadCornBalance();
      totalHarvested = cornBalance;
      applyOfflineBonus();
      updateCornBalanceDisplay();
      updateCornWalletDisplay();
      bindFieldEvents();
      startFieldTickLoop();
      bindCornWallet();
    }

    // Ensure latest field state is persisted when leaving the page
    window.addEventListener('beforeunload', function () {
      saveFieldStates();
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDashboard);
    } else {
      initDashboard();
    }
  </script>
</body>
</html>
