<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MiiBoard ‚Äì Corn Transfer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="app">
    <header class="toolbar">
      <div class="toolbar-left">
        <div class="logo-orb"></div>
        <span class="logo-text">MiiBoard</span>
      </div>
      <div class="toolbar-center">
        <a href="index.html" class="toolbar-btn">Home</a>
        <a href="stats.html" class="toolbar-btn">Stats</a>
        <a href="transfer.html" class="toolbar-btn toolbar-btn-active">Transfer</a>
      </div>
      <div class="toolbar-right">
        <div class="corn-wallet-wrapper">
          <div class="corn-balance" id="corn-balance" aria-expanded="false">
            üåΩ <span class="corn-balance-value">0</span>
          </div>
          <div class="corn-wallet" id="corn-wallet" aria-hidden="true">
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Current corn</span>
              <span class="corn-wallet-value corn-wallet-current">0</span>
            </div>
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Total harvested</span>
              <span class="corn-wallet-value corn-wallet-total">0</span>
            </div>
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Best harvest</span>
              <span class="corn-wallet-value corn-wallet-best">0</span>
            </div>
            <div class="corn-wallet-row">
              <span class="corn-wallet-label">Last harvest</span>
              <span class="corn-wallet-value corn-wallet-last">&mdash;</span>
            </div>
          </div>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false" type="button">‚òÄÔ∏è</button>
        <span class="toolbar-time" id="toolbar-time">--:--</span>
        <div class="avatar"></div>
      </div>
    </header>
    <main class="dashboard" id="main-content">
      <section class="main-panel">
        <div class="main-panel-inner">
          <div class="farm-header">
            <h1 class="main-panel-title">Corn Transfer</h1>
            <p class="main-panel-subtitle">Convert 100 corn into 2 corn coins to use in the Corn Roller.</p>
          </div>
          <div class="transfer-card">
            <div class="transfer-stats">
              <div class="transfer-row">
                <span class="transfer-label">Corn</span>
                <span class="transfer-value" id="transfer-corn">0</span>
              </div>
              <div class="transfer-row">
                <span class="transfer-label">Coins</span>
                <span class="transfer-value" id="transfer-coins">0</span>
              </div>
            </div>
            <button class="transfer-btn" id="transfer-btn" type="button">Convert 100 corn ‚Üí 2 coins</button>
            <div class="transfer-result" id="transfer-result">Ready to transfer.</div>
          </div>
        </div>
      </section>
    </main>
    <div class="global-toast" id="ready-toast" aria-live="polite" aria-atomic="true"></div>
  </div>
  <script>
    var cornBalance = 0;
    var cornCoins = 0;
    var CORN_STORAGE_KEY = 'miiboard_corn_balance';
    var CORN_LAST_SEEN_KEY = 'miiboard_last_seen';
    var CORN_COINS_KEY = 'miiboard_corn_coins';
    var FIELD_STORAGE_KEY = 'miiboard_field_states';
    var FIELD_GROWTH_MS = 10000;
    var totalHarvested = 0;
    var bestHarvest = 0;
    var lastHarvest = 0;
    var readyToastHideTimerId = null;
    var lastReadyToastCount = 0;

    function updateTime() {
      var el = document.getElementById('toolbar-time');
      if (!el) return;
      var now = new Date();
      var hours = now.getHours();
      var minutes = now.getMinutes().toString().padStart(2, '0');
      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      el.textContent = hours + ':' + minutes + ' ' + ampm;
    }

    function updateCornBalanceDisplay() {
      var container = document.getElementById('corn-balance');
      if (!container) return;
      var valueEl = container.querySelector('.corn-balance-value');
      if (valueEl) {
        valueEl.textContent = cornBalance;
      } else {
        container.textContent = '\ud83c\udf3d ' + cornBalance;
      }
    }

    function loadCornBalance() {
      try {
        if (!window.localStorage) return;
        var stored = localStorage.getItem(CORN_STORAGE_KEY);
        if (stored !== null) {
          var parsed = parseInt(stored, 10);
          if (!isNaN(parsed) && parsed >= 0) {
            cornBalance = parsed;
          }
        }
      } catch (e) {
      }
    }

    function saveCornBalance() {
      try {
        if (!window.localStorage) return;
        localStorage.setItem(CORN_STORAGE_KEY, String(cornBalance));
        localStorage.setItem(CORN_LAST_SEEN_KEY, String(Date.now()));
      } catch (e) {
      }
    }

    function loadCornCoins() {
      try {
        if (!window.localStorage) return;
        var stored = localStorage.getItem(CORN_COINS_KEY);
        if (stored !== null) {
          var parsed = parseInt(stored, 10);
          if (!isNaN(parsed) && parsed >= 0) {
            cornCoins = parsed;
          }
        }
      } catch (e) {
      }
    }

    function saveCornCoins() {
      try {
        if (!window.localStorage) return;
        localStorage.setItem(CORN_COINS_KEY, String(cornCoins));
      } catch (e) {
      }
    }

    function updateTransferDisplay() {
      var cornEl = document.getElementById('transfer-corn');
      var coinsEl = document.getElementById('transfer-coins');
      if (cornEl) cornEl.textContent = cornBalance;
      if (coinsEl) coinsEl.textContent = cornCoins;
    }

    function updateCornWalletDisplay() {
      var wallet = document.getElementById('corn-wallet');
      if (!wallet) return;
      var currentEl = wallet.querySelector('.corn-wallet-current');
      var totalEl = wallet.querySelector('.corn-wallet-total');
      var bestEl = wallet.querySelector('.corn-wallet-best');
      var lastEl = wallet.querySelector('.corn-wallet-last');
      if (currentEl) currentEl.textContent = cornBalance;
      if (totalEl) totalEl.textContent = totalHarvested;
      if (bestEl) bestEl.textContent = bestHarvest;
      if (lastEl) lastEl.textContent = lastHarvest > 0 ? lastHarvest : '\u2014';
    }

    function loadStoredFieldStates() {
      try {
        if (!window.localStorage) return null;
        var raw = localStorage.getItem(FIELD_STORAGE_KEY);
        if (!raw) return null;
        var parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch (e) {
        return null;
      }
    }

    function computeReadyCountFromStoredFields() {
      var stored = loadStoredFieldStates();
      if (!stored) return 0;
      var now = Date.now();
      var ready = 0;
      stored.forEach(function (data, index) {
        if (!data) return;
        var state = data.state || 'empty';
        var progress = typeof data.progress === 'number' ? data.progress : 0;
        var growMs = index >= 8 ? FIELD_GROWTH_MS * 4 : FIELD_GROWTH_MS;
        var startTime = typeof data.startTime === 'number' ? data.startTime : null;

        if (state === 'ready') {
          ready++;
          return;
        }
        if (state === 'growing') {
          if (typeof startTime !== 'number') {
            if (progress > 0 && progress < 100) {
              startTime = now - (progress / 100) * growMs;
            } else {
              startTime = now;
            }
          }
          var elapsed = now - startTime;
          if (elapsed >= growMs) {
            ready++;
          }
        }
      });
      return ready;
    }

    function showReadyToast(count) {
      var toast = document.getElementById('ready-toast');
      if (!toast) return;
      var label = count === 1 ? '1 field is ready to harvest' : count + ' fields are ready to harvest';
      toast.textContent = '\ud83c\udf3d ' + label;
      toast.classList.add('is-visible');
      if (readyToastHideTimerId !== null) {
        clearTimeout(readyToastHideTimerId);
      }
      readyToastHideTimerId = setTimeout(function () {
        toast.classList.remove('is-visible');
      }, 3500);
    }

    function checkAndShowReadyToast() {
      var count = computeReadyCountFromStoredFields();
      if (count > 0 && count !== lastReadyToastCount) {
        lastReadyToastCount = count;
        showReadyToast(count);
      }
    }

    function bindCornWallet() {
      var balance = document.getElementById('corn-balance');
      var wallet = document.getElementById('corn-wallet');
      if (!balance || !wallet) return;
      var isOpen = false;

      function setOpen(open) {
        isOpen = open;
        if (open) {
          wallet.classList.add('is-open');
          balance.setAttribute('aria-expanded', 'true');
          wallet.setAttribute('aria-hidden', 'false');
        } else {
          wallet.classList.remove('is-open');
          balance.setAttribute('aria-expanded', 'false');
          wallet.setAttribute('aria-hidden', 'true');
        }
      }

      balance.setAttribute('role', 'button');
      balance.setAttribute('tabindex', '0');

      balance.addEventListener('click', function (event) {
        event.stopPropagation();
        setOpen(!isOpen);
      });

      balance.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          setOpen(!isOpen);
        }
      });

      document.addEventListener('click', function (event) {
        if (!isOpen) return;
        if (!wallet.contains(event.target) && !balance.contains(event.target)) {
          setOpen(false);
        }
      });
    }

    function bindTransfer() {
      var btn = document.getElementById('transfer-btn');
      var resultEl = document.getElementById('transfer-result');
      if (!btn || !resultEl) return;

      btn.addEventListener('click', function () {
        resultEl.textContent = '';
        if (cornBalance < 100) {
          resultEl.textContent = 'Need 100 corn to get 2 coins.';
          return;
        }
        cornBalance -= 100;
        cornCoins += 2;
        saveCornBalance();
        saveCornCoins();
        updateCornBalanceDisplay();
        updateCornWalletDisplay();
        updateTransferDisplay();
        resultEl.textContent = 'Converted 100 corn into 2 corn coins.';
      });
    }

    function initTransferPage() {
      updateTime();
      setInterval(updateTime, 60000);
      loadCornBalance();
      loadCornCoins();
      totalHarvested = cornBalance;
      updateCornBalanceDisplay();
      updateCornWalletDisplay();
      updateTransferDisplay();
      bindCornWallet();
      bindTransfer();
      checkAndShowReadyToast();
      setInterval(checkAndShowReadyToast, 1000);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTransferPage);
    } else {
      initTransferPage();
    }
  </script>
  <script src="main.js"></script>
</body>
</html>
